using System.Collections;
using UnityEngine;

/// <summary>
/// Simple audio script for character footstep sounds.
/// </summary>
public class FootstepAudioComponent : MonoBehaviour {
    // Simple audio script for character footstep sounds
    // Useful for 3D spatialized footstep sounds on first person characters
    // Includes optional ability to adjust footstep interval based on character movement speed

    // Works by attaching audio sources to each foot object
    // Then plays the footstep sound alternating between foots at a set interval

    // Usage:
    // - Attach this script to any object (preferably a game character)
    // - Assign the footstep sound effect to the FootstepSFX field
    // - Assign the left and right foot transforms to the LeftFoot and RightFoot fields
    // - Adjust the FootstepInterval and FootstepVolume fields as needed
    // - Adjust the feet transform positions to match the character's feet positions, so audio is spatialized correctly
    // - Optionally override the MovementSpeedAlpha method to adjust the footstep interval based on character movement speed
    // Important:
    // - Call the OnMovementStarted method when the character starts moving and OnMovementStopped when it stops, this tells the script when to play footstep sounds

    // Note: It might be useful to crete a reusable prefab for the footstep audio sources, and place it as a child of game characters.
    // This way the audio sources follow the characters, but won't interfere with other character logic.

    #region Properties

    [Tooltip("Volume of the footstep sounds")]
    public float FootstepVolume = 1f;
    [Tooltip("Audio clip to use for the footstep sounds")]
    public AudioClip FootstepSFX;
    [Tooltip("Transform for the left foot")]
    public Transform LeftFoot;
    [Tooltip("Transform for the right foot")]
    public Transform RightFoot;
    [Tooltip("Maximum time between footsteps")]
    public float MaxFootstepInterval = 0.5f;
    [Tooltip("Minimum time bwteen footsteps")]
    public float MinFootstepInterval = 0.3f;

    private AudioSource leftFootAudioSource;
    private AudioSource rightFootAudioSource;
    private Coroutine footstepCoroutine;
    private float lastFootstepTime = -1f;
    private bool isRightFoot = true;
    private float actualFootstepInterval = 0.5f; // Smoothly adjusted footstep interval based on character speed and min and max values

    #endregion

    protected virtual void Start() {
        // Add footstep audio sources to each foot transform
        leftFootAudioSource = LeftFoot.gameObject.AddComponent<AudioSource>();
        rightFootAudioSource = RightFoot.gameObject.AddComponent<AudioSource>();
        // Init the audio sources
        leftFootAudioSource.clip = FootstepSFX;
        rightFootAudioSource.clip = FootstepSFX;
        leftFootAudioSource.spatialBlend = 1;
        rightFootAudioSource.spatialBlend = 1;
        leftFootAudioSource.volume = FootstepVolume;
        rightFootAudioSource.volume = FootstepVolume;
        leftFootAudioSource.loop = false;
        rightFootAudioSource.loop = false;
    }

    private void Update() {
        // Clamp the movement speed alpha to 0-1 range, just in case this is not done in child classes
        float speedAlpha = Mathf.Clamp(MovementSpeedAlpha(), 0f, 1f);
        // Smoothly adjust the footstep interval based on the character's movement speed
        actualFootstepInterval = Mathf.Lerp(MaxFootstepInterval, MinFootstepInterval, speedAlpha);
    }

    /// <summary>
    /// Returns value between 0 and 1 representing the character's current walk speed. 0 means default walk speed, 1 means maximum walk speed. Override this method to provide custom logic for determining the movement speed alpha.
    /// </summary>
    protected virtual float MovementSpeedAlpha() {
        // Default implementation, override this method to provide custom logic for determining the movement speed alpha
        return 0f;
    }   

    public void OnMovementStarted() {
        // Start the footstep coroutine if it's not already running
        if (footstepCoroutine == null) {
            footstepCoroutine = StartCoroutine(PlayFootstepSound());
        }
    }

    public void OnMovementStopped() {
        // Stop the footstep coroutine
        if (footstepCoroutine != null) {
            StopCoroutine(footstepCoroutine);
            footstepCoroutine = null;
        }
    }

    private IEnumerator PlayFootstepSound() {
        while (true) {
            // Check if enough time has passed since the last footstep sound
            if (Time.time - lastFootstepTime >= actualFootstepInterval) {
                // Alternate between left and right foot
                if (isRightFoot) {
                    rightFootAudioSource.Play();
                } else {
                    leftFootAudioSource.Play();
                }

                // Toggle the foot
                isRightFoot = !isRightFoot;

                // Update the last footstep time
                lastFootstepTime = Time.time;
            } else {
                yield return new WaitForSeconds(actualFootstepInterval - (Time.time - lastFootstepTime));
            }

            // Wait for the footstep interval before playing the next sound
            yield return new WaitForSeconds(actualFootstepInterval);
        }
    }
}

